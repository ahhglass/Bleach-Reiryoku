name: Release Mod Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate manifest
        id: manifest
        run: |
          if [ ! -f manifest.json ]; then
            echo "::error::manifest.json not found in repository"
            exit 1
          fi
          VERSION=$(jq -r '.Version // empty' manifest.json)
          if [ -z "$VERSION" ]; then
            echo "::error::manifest.json must contain a non-empty Version field"
            exit 1
          fi
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          if [ "$TAG_VERSION" != "$VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match manifest.json Version ($VERSION)"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create mod archive (exclude docs, .github)
        run: |
          MOD_NAME="Bleach-Reiryoku-${{ steps.manifest.outputs.VERSION }}"
          mkdir -p dist/$MOD_NAME
          
          cp manifest.json dist/$MOD_NAME/
          cp -r Common dist/$MOD_NAME/
          cp -r Server dist/$MOD_NAME/
          
          cd dist
          zip -r "../Bleach-Reiryoku-${{ steps.manifest.outputs.VERSION }}.zip" "$MOD_NAME"
          cd ..

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: Bleach-Reiryoku-${{ steps.manifest.outputs.VERSION }}.zip
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
